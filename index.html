<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Signal Webtool – mit TV-Import</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Optional: Mini-Styles nur für diese Demo-Seite (dein Design bleibt unberührt, wenn du nur den Import-Block übernimmst) -->
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:980px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 16px}
    .grid{display:grid;grid-template-columns:200px 1fr;gap:10px;margin:10px 0}
    input,select{padding:8px;border:1px solid #ccc;border-radius:8px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:18px 0}
    .muted{opacity:.7}
  </style>
</head>
<body>

  <h1>Signal Webtool (Demo mit TV-Import)</h1>

  <div class="card">
    <div class="grid">
      <label for="date">Datum</label>
      <input id="date" name="date" type="date">
    </div>

    <div class="grid">
      <label for="market">Market</label>
      <select id="market" name="market">
        <!-- Beispiel-Einträge; dein Tool kann hier andere Werte haben -->
        <option value="">— wählen —</option>
        <option>BTC</option>
        <option>BTCUSDT</option>
        <option>ETH</option>
        <option>SOL</option>
      </select>
    </div>

    <div class="grid">
      <label for="cPrice">Aktueller Kurs (cPrice)</label>
      <input id="cPrice" name="cPrice" type="text" placeholder="wird vom Import gesetzt">
    </div>

    <div class="grid">
      <label for="cOpen">Eröffnung (cOpen)</label>
      <input id="cOpen" name="cOpen" type="text" placeholder="wird vom Import gesetzt">
    </div>

    <div class="grid">
      <label for="cHigh">Vortageshoch (cHigh)</label>
      <input id="cHigh" name="cHigh" type="text" placeholder="wird vom Import gesetzt">
    </div>

    <div class="grid">
      <label for="cLow">Vortagestief (cLow)</label>
      <input id="cLow" name="cLow" type="text" placeholder="wird vom Import gesetzt">
    </div>

    <div class="grid">
      <label for="cATR">ATR(14) Daily (cATR)</label>
      <input id="cATR" name="cATR" type="text" placeholder="wird vom Import gesetzt">
    </div>

    <p class="muted">Hinweis: Der TV-Import klickt/füllt nur diese Felder. Dein restliches UI bleibt unverändert.</p>
  </div>

  <!-- =========================================================
       AJS TV-IMPORT (inline, keine externen Dateien nötig)
       → Diesen gesamten Block in deine bestehende index.html
         direkt vor </body> einfügen, wenn du nur integrieren willst.
       ========================================================= -->
  <style id="ajs-tv-css">
    #ajs-tv{position:fixed;left:12px;bottom:12px;z-index:99999;font-family:system-ui,Arial,sans-serif}
    #ajs-tv-toggle{background:#0ea5e9;color:#fff;border:none;border-radius:10px;padding:8px 12px;box-shadow:0 4px 14px rgba(0,0,0,.15);cursor:pointer}
    #ajs-tv-panel{position:fixed;left:12px;bottom:56px;width:360px;max-width:90vw;background:#111;color:#fff;border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    #ajs-tv-panel label{display:block;font-weight:600;margin-bottom:6px}
    #ajs-tv-panel textarea{width:100%;min-height:140px;border-radius:8px;border:1px solid #333;background:#1a1a1a;color:#fff;padding:8px;font-family:ui-monospace, Menlo, monospace}
    #ajs-tv .row{margin:10px 0}
    #ajs-tv .actions{display:flex;gap:8px;flex-wrap:wrap}
    #ajs-tv .primary{background:#22c55e;color:#111;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    #ajs-tv .ghost{background:#333;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    #ajs-tv .msg{margin-top:8px;font-size:12px;opacity:.9}
    #ajs-tv .msg.ok{color:#22c55e} .msg.warn{color:#f59e0b}
  </style>
  <div id="ajs-tv">
    <button id="ajs-tv-toggle" aria-expanded="false" title="TradingView-Daten einfügen">TV-Import</button>
    <div id="ajs-tv-panel" hidden>
      <div class="row">
        <label>Einfügen (Text aus deinem TradingView-Indikator)</label>
        <textarea id="ajs-tv-txt" placeholder="Hier den Text aus dem TradingView-Indikator einfügen…"></textarea>
      </div>
      <div class="row">
        <div style="opacity:.8;font-size:12px">Oder eine <b>.txt</b>-Datei laden:</div>
        <input type="file" id="ajs-tv-file" accept=".txt,text/plain">
      </div>
      <div class="row actions">
        <button id="ajs-tv-paste">Aus Zwischenablage einfügen</button>
        <button id="ajs-tv-apply" class="primary">Übernehmen</button>
        <button id="ajs-tv-close" class="ghost">Schließen</button>
      </div>
      <div id="ajs-tv-msg" class="msg" aria-live="polite"></div>
    </div>
  </div>
  <script>
  (function(){
    const Q=(s,r=document)=>r.querySelector(s);
    const msg=(t,cls="")=>{const m=Q("#ajs-tv-msg"); if(!m)return; m.className="msg "+cls; m.textContent=t;}
    const deNum=(s)=>{ if(s==null)return null; s=(""+s).trim(); if(!s)return null;
      if(s.includes(",")&&s.includes(".")){ s=s.replace(/\./g,"").replace(",","."); }
      else if(s.includes(",")){ s=s.replace(",","."); }
      const n=Number(s); return Number.isFinite(n)?n:null;
    };
    function parse(text){
      const get=(label)=>{ const re=new RegExp(label+"\\s*:\\s*([^\\n\\r]+)","i"); const m=text.match(re); return m?m[1].trim():null; };
      const date=get("Datum");
      const marketRaw=get("Markt");
      const price=deNum(get("Aktueller\\s*Kurs"));
      const prevHigh=deNum(get("Vortageshoch"));
      const prevLow=deNum(get("Vortagestief"));
      const open=deNum(get("Eröffnung"));
      const atrMatch=text.match(/ATR\\s*\\(.*?\\)\\s*:\\s*([^\\n\\r]+)/i);
      const atr=deNum(atrMatch?atrMatch[1].trim():null);

      // Basis aus Markt ableiten (BTCUSDT -> BTC, BTC/USDT -> BTC, ES1! -> ES)
      let base="";
      if(marketRaw){
        const m=marketRaw.toUpperCase();
        const m1=m.match(/^([A-Z]{2,6})/);
        base=m1?m1[1]:m;
        base=base.replace(/(USDT|USD)$/,"");
      }
      return {date, base, price, prevHigh, prevLow, open, atr};
    }
    function pick(sel){
      return document.getElementById(sel)
        || document.querySelector('[name="'+sel+'"]')
        || document.querySelector('[data-ajs="'+sel+'"]')
        || null;
    }
    function put(id,val,dig){ const el=pick(id); if(!el||val==null||!isFinite(val)) return false; el.value=Number(val).toFixed(dig); return true; }
    function setMarket(base){
      if(!base) return false;
      const el=document.getElementById("market")||document.querySelector('[name="market"]');
      if(!el) return false;
      const opts=Array.from(el.options||[]);
      const e1=opts.find(o=>o.value.toUpperCase()===base || (o.textContent||"").toUpperCase()===base);
      if(e1){ el.value=e1.value; el.dispatchEvent(new Event("change",{bubbles:true})); return true; }
      const e2=opts.find(o=>((o.textContent||"")+o.value).toUpperCase().includes(base));
      if(e2){ el.value=e2.value; el.dispatchEvent(new Event("change",{bubbles:true})); return true; }
      return false;
    }

    // UI
    const btn=Q("#ajs-tv-toggle"), panel=Q("#ajs-tv-panel"), ta=Q("#ajs-tv-txt"), file=Q("#ajs-tv-file");
    btn.onclick=()=>{ const open=panel.hidden; panel.hidden=!open; btn.setAttribute("aria-expanded", String(open)); };
    Q("#ajs-tv-close").onclick=()=>{ panel.hidden=true; btn.setAttribute("aria-expanded","false"); };

    Q("#ajs-tv-paste").onclick=async ()=>{
      try{
        const t=await navigator.clipboard.readText();
        if(t){ ta.value=t; msg("Text eingefügt. Jetzt „Übernehmen“ klicken."); }
        else{ msg("Zwischenablage leer oder blockiert. Text manuell einfügen.", "warn"); }
      }catch(_){ msg("Kein Zugriff auf Zwischenablage. Text manuell einfügen.", "warn"); }
    };
    file.onchange=async (ev)=>{
      const f=ev.target.files && ev.target.files[0]; if(!f) return;
      ta.value=await f.text(); msg("Datei geladen. Jetzt „Übernehmen“ klicken.");
    };

    Q("#ajs-tv-apply").onclick=()=>{
      const raw=ta.value||""; if(!raw.trim()){ msg("Bitte zuerst Text einfügen oder Datei laden.", "warn"); return; }
      const d=parse(raw);
      let ok=false;
      ok=setMarket(d.base)||ok;
      ok=put("cPrice", d.price, 2)||ok;
      ok=put("cOpen",  d.open , 2)||ok;
      ok=put("cHigh",  d.prevHigh, 2)||ok; // Vortageshoch -> cHigh
      ok=put("cLow",   d.prevLow , 2)||ok; // Vortagestief -> cLow
      ok=put("cATR",   d.atr    , 4)||ok;
      const dateEl=document.getElementById("date")||document.querySelector('[name="date"]');
      if(dateEl && d.date){ try{ dateEl.value=d.date; ok=true; }catch(_){} }

      if(ok){ msg("Werte übernommen ✅","ok"); panel.hidden=true; btn.setAttribute("aria-expanded","false"); }
      else { msg("Keine passenden Eingabefelder gefunden. Prüfe IDs/Namen: market, date, cPrice, cOpen, cHigh, cLow, cATR","warn"); }
    };
  })();
  </script>
  <!-- /AJS TV-IMPORT -->

</body>
</html>
